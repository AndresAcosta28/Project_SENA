name: Deploy Backend to AWS

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Elastic Beanstalk
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      # ==========================================
      # 1. PREPARACIÃ“N
      # ==========================================
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 1

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # ==========================================
      # 2. OBTENER INFORMACIÃ“N DE TERRAFORM
      # ==========================================
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.13.5
          terraform_wrapper: false

      - name: Initialize Terraform
        working-directory: terraform/dev
        run: terraform init

      - name: Get Infrastructure Outputs
        id: infra
        working-directory: terraform/dev
        run: |
          EB_APP=$(terraform output -raw backend_app_name)
          EB_ENV=$(terraform output -raw backend_env_name)
          BACKEND_URL=$(terraform output -raw backend_url)
          
          echo "eb_app=$EB_APP" >> $GITHUB_OUTPUT
          echo "eb_env=$EB_ENV" >> $GITHUB_OUTPUT
          echo "backend_url=$BACKEND_URL" >> $GITHUB_OUTPUT
          
          echo "ğŸš€ EB Application: $EB_APP"
          echo "ğŸŒ EB Environment: $EB_ENV"
          echo "ğŸ”— Backend URL: $BACKEND_URL"

      # ==========================================
      # 3. VALIDACIÃ“N PRE-DEPLOYMENT
      # ==========================================
      - name: Validate Backend Structure
        run: |
          echo "ğŸ” Validating backend structure..."
          
          if [ ! -d "backend" ]; then
            echo "âŒ ERROR: backend/ directory not found"
            exit 1
          fi
          
          if [ ! -f "backend/application.py" ] && [ ! -f "backend/app.py" ]; then
            echo "âŒ ERROR: No application.py or app.py found in backend/"
            exit 1
          fi
          
          if [ ! -f "backend/requirements.txt" ]; then
            echo "âŒ ERROR: requirements.txt not found in backend/"
            exit 1
          fi
          
          echo "âœ… Backend structure is valid"
          echo ""
          echo "ğŸ“‚ Backend files:"
          ls -lah backend/

      # ==========================================
      # 4. CREAR PAQUETE DE DEPLOYMENT
      # ==========================================
      - name: Generate Version Label
        id: version
        run: |
          VERSION="v-$(date +%Y%m%d-%H%M%S)-${GITHUB_SHA::7}"
          echo "label=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Version: $VERSION"

      - name: Create Deployment Package
        working-directory: backend
        run: |
          echo "ğŸ“¦ Creating deployment package..."
          
          # Crear ZIP excluyendo archivos innecesarios
          zip -r ../backend-${{ steps.version.outputs.label }}.zip . \
            -x "*.git*" \
            -x "*__pycache__*" \
            -x "*.pyc" \
            -x "*.pyo" \
            -x "venv/*" \
            -x ".env" \
            -x "*.log" \
            -x ".DS_Store" \
            -x "node_modules/*"
          
          echo "âœ… Package created: backend-${{ steps.version.outputs.label }}.zip"
          
          # Mostrar tamaÃ±o del paquete
          ls -lh ../backend-${{ steps.version.outputs.label }}.zip

      # ==========================================
      # 5. UPLOAD A S3
      # ==========================================
      - name: Upload Package to S3
        run: |
          echo "ğŸ“¤ Uploading deployment package to S3..."
          
          # Obtener el bucket de Elastic Beanstalk
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          EB_BUCKET="elasticbeanstalk-${{ secrets.AWS_REGION }}-${ACCOUNT_ID}"
          
          echo "Uploading to: s3://$EB_BUCKET/"
          
          aws s3 cp backend-${{ steps.version.outputs.label }}.zip \
            s3://$EB_BUCKET/backend-${{ steps.version.outputs.label }}.zip
          
          echo "âœ… Package uploaded"
          echo "eb_bucket=$EB_BUCKET" >> $GITHUB_OUTPUT
        id: s3_upload

      # ==========================================
      # 6. CREAR VERSIÃ“N EN ELASTIC BEANSTALK
      # ==========================================
      - name: Create Application Version
        run: |
          echo "ğŸ“ Creating Elastic Beanstalk application version..."
          
          aws elasticbeanstalk create-application-version \
            --application-name ${{ steps.infra.outputs.eb_app }} \
            --version-label ${{ steps.version.outputs.label }} \
            --source-bundle S3Bucket="${{ steps.s3_upload.outputs.eb_bucket }}",S3Key="backend-${{ steps.version.outputs.label }}.zip" \
            --description "Deployed from GitHub Actions - Commit: ${{ github.sha }}"
          
          echo "âœ… Application version created"

      # ==========================================
      # 7. DEPLOY A ELASTIC BEANSTALK
      # ==========================================
      - name: Deploy to Elastic Beanstalk
        run: |
          echo "ğŸš€ Deploying to Elastic Beanstalk environment..."
          
          aws elasticbeanstalk update-environment \
            --application-name ${{ steps.infra.outputs.eb_app }} \
            --environment-name ${{ steps.infra.outputs.eb_env }} \
            --version-label ${{ steps.version.outputs.label }}
          
          echo "âœ… Deployment initiated"

      # ==========================================
      # 8. ESPERAR DEPLOYMENT
      # ==========================================
      - name: Wait for Deployment
        run: |
          echo "â³ Waiting for environment to update (this may take 5-10 minutes)..."
          
          aws elasticbeanstalk wait environment-updated \
            --application-name ${{ steps.infra.outputs.eb_app }} \
            --environment-name ${{ steps.infra.outputs.eb_env }}
          
          echo "âœ… Environment updated successfully"

      # ==========================================
      # 9. VERIFICACIÃ“N POST-DEPLOYMENT
      # ==========================================
      - name: Verify Deployment
        run: |
          echo "ğŸ” Verifying deployment..."
          
          # Obtener el estado del environment
          ENV_STATUS=$(aws elasticbeanstalk describe-environments \
            --application-name ${{ steps.infra.outputs.eb_app }} \
            --environment-names ${{ steps.infra.outputs.eb_env }} \
            --query "Environments[0].Status" \
            --output text)
          
          ENV_HEALTH=$(aws elasticbeanstalk describe-environments \
            --application-name ${{ steps.infra.outputs.eb_app }} \
            --environment-names ${{ steps.infra.outputs.eb_env }} \
            --query "Environments[0].Health" \
            --output text)
          
          echo "Status: $ENV_STATUS"
          echo "Health: $ENV_HEALTH"
          
          if [ "$ENV_STATUS" != "Ready" ]; then
            echo "âš ï¸  WARNING: Environment status is not Ready"
          fi
          
          if [ "$ENV_HEALTH" != "Green" ] && [ "$ENV_HEALTH" != "Yellow" ]; then
            echo "âŒ ERROR: Environment health is $ENV_HEALTH"
            exit 1
          fi
          
          echo "âœ… Deployment verified"

      # ==========================================
      # 10. RESUMEN
      # ==========================================
      - name: Deployment Summary
        if: success()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… BACKEND DEPLOYED SUCCESSFULLY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸš€ Application: ${{ steps.infra.outputs.eb_app }}"
          echo "ğŸŒ Environment: ${{ steps.infra.outputs.eb_env }}"
          echo "ğŸ”– Version: ${{ steps.version.outputs.label }}"
          echo "ğŸ”— URL: ${{ steps.infra.outputs.backend_url }}"
          echo ""
          echo "ğŸ“ Git Info:"
          echo "   Commit: ${{ github.sha }}"
          echo "   Author: ${{ github.actor }}"
          echo "   Message: ${{ github.event.head_commit.message }}"
          echo ""
          echo "ğŸ§ª Test the API:"
          echo "   curl ${{ steps.infra.outputs.backend_url }}/health"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Deployment Failed
        if: failure()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ DEPLOYMENT FAILED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ” Check Elastic Beanstalk logs:"
          echo "   aws elasticbeanstalk request-environment-info \\"
          echo "     --environment-name ${{ steps.infra.outputs.eb_env }} \\"
          echo "     --info-type tail"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
