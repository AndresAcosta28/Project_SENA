name: Deploy Frontend (Nuclear Option)

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          ref: main
          fetch-depth: 0
          clean: true  # Limpia el workspace

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.13.5
          terraform_wrapper: false

      - name: Initialize Terraform
        working-directory: terraform/dev
        run: terraform init -upgrade

      - name: Get Terraform Outputs
        id: tf_outputs
        working-directory: terraform/dev
        run: |
          echo "s3_bucket=$(terraform output -raw frontend_s3_bucket)" >> $GITHUB_OUTPUT
          echo "cloudfront_id=$(terraform output -raw cloudfront_distribution_id)" >> $GITHUB_OUTPUT

      - name: Nuclear option - Delete everything from S3
        run: |
          echo "ðŸ’£ Borrando TODO de S3..."
          aws s3 rm s3://${{ steps.tf_outputs.outputs.s3_bucket }} --recursive

      - name: Upload files with cp (not sync)
        run: |
          echo "ðŸ“¤ Subiendo archivos uno por uno..."
          cd frontend/public/
          for file in $(find . -type f); do
            echo "Uploading: $file"
            aws s3 cp "$file" "s3://${{ steps.tf_outputs.outputs.s3_bucket }}/$file" \
              --cache-control "no-cache, no-store, must-revalidate"
          done

      - name: Verify what was uploaded
        run: |
          echo "ðŸ“‹ Verificando S3:"
          aws s3 ls s3://${{ steps.tf_outputs.outputs.s3_bucket }}/ --recursive --human-readable

      - name: Nuclear CloudFront invalidation
        run: |
          echo "ðŸ’¥ Invalidando CloudFront..."
          aws cloudfront create-invalidation \
            --distribution-id ${{ steps.tf_outputs.outputs.cloudfront_id }} \
            --paths "/*"

      - name: Done
        run: |
          echo "âœ… Deployment nuclear completado"
          echo "ðŸ”— Espera 3-5 minutos y abre en modo incÃ³gnito"