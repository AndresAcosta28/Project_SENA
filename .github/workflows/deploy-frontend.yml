name: Deploy Frontend to AWS

on:
  push:
    branches:
      - main
    paths:
      - 'frontend/**'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to S3 and CloudFront
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      # ==========================================
      # 1. PREPARACIÃ“N
      # ==========================================
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 1

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # ==========================================
      # 2. OBTENER INFORMACIÃ“N DE TERRAFORM
      # ==========================================
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.13.5
          terraform_wrapper: false

      - name: Initialize Terraform
        working-directory: terraform/dev
        run: terraform init

      - name: Get Infrastructure Outputs
        id: infra
        working-directory: terraform/dev
        run: |
          S3_BUCKET=$(terraform output -raw frontend_s3_bucket)
          CF_ID=$(terraform output -raw cloudfront_distribution_id)
          CF_URL=$(terraform output -raw frontend_cloudfront_url)
          
          echo "s3_bucket=$S3_BUCKET" >> $GITHUB_OUTPUT
          echo "cloudfront_id=$CF_ID" >> $GITHUB_OUTPUT
          echo "cloudfront_url=$CF_URL" >> $GITHUB_OUTPUT
          
          echo "ğŸ“¦ S3 Bucket: $S3_BUCKET"
          echo "â˜ï¸  CloudFront ID: $CF_ID"
          echo "ğŸŒ CloudFront URL: $CF_URL"

      # ==========================================
      # 3. VALIDACIÃ“N PRE-DEPLOYMENT
      # ==========================================
      - name: Validate Frontend Structure
        run: |
          echo "ğŸ” Validating frontend structure..."
          
          # Verificar que existe la carpeta frontend
          if [ ! -d "frontend/public" ]; then
            echo "âŒ ERROR: frontend/public/ directory not found"
            echo "Available directories:"
            ls -la frontend/ || ls -la
            exit 1
          fi
          
          # Verificar que existen archivos esenciales
          if [ ! -f "frontend/public/index.html" ]; then
            echo "âŒ ERROR: index.html not found in frontend/public/"
            exit 1
          fi
          
          echo "âœ… Frontend structure is valid"
          echo ""
          echo "ğŸ“‚ Files to deploy:"
          find frontend/public -type f -exec ls -lh {} \;

      # ==========================================
      # 4. LIMPIAR S3 (Evitar archivos huÃ©rfanos)
      # ==========================================
      - name: Clean S3 Bucket
        run: |
          echo "ğŸ§¹ Cleaning S3 bucket..."
          aws s3 rm s3://${{ steps.infra.outputs.s3_bucket }} --recursive
          echo "âœ… S3 bucket cleaned"

      # ==========================================
      # 5. UPLOAD A S3
      # ==========================================
      - name: Upload to S3
        run: |
          echo "ğŸ“¤ Uploading files to S3..."
          
          # Upload usando cp --recursive para evitar problemas de rutas
          aws s3 cp frontend/public/ s3://${{ steps.infra.outputs.s3_bucket }}/ \
            --recursive \
            --cache-control "no-cache, no-store, must-revalidate" \
            --metadata-directive REPLACE
          
          echo "âœ… Upload completed"

      # ==========================================
      # 6. VERIFICACIÃ“N POST-UPLOAD
      # ==========================================
      - name: Verify S3 Upload
        run: |
          echo "ğŸ” Verifying uploaded files..."
          echo ""
          
          # Listar archivos en S3
          echo "Files in S3:"
          aws s3 ls s3://${{ steps.infra.outputs.s3_bucket }}/ --recursive --human-readable
          echo ""
          
          # Verificar que index.html existe y obtener su contenido
          if aws s3 ls s3://${{ steps.infra.outputs.s3_bucket }}/index.html > /dev/null 2>&1; then
            echo "âœ… index.html found in S3"
            echo ""
            echo "ğŸ“„ First 20 lines of index.html from S3:"
            aws s3 cp s3://${{ steps.infra.outputs.s3_bucket }}/index.html - | head -20
          else
            echo "âŒ ERROR: index.html NOT found in S3"
            exit 1
          fi

      # ==========================================
      # 7. INVALIDAR CLOUDFRONT
      # ==========================================
      - name: Invalidate CloudFront Cache
        run: |
          echo "ğŸ”„ Creating CloudFront invalidation..."
          
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id ${{ steps.infra.outputs.cloudfront_id }} \
            --paths "/*" \
            --query 'Invalidation.Id' \
            --output text)
          
          echo "âœ… Invalidation created: $INVALIDATION_ID"
          echo "invalidation_id=$INVALIDATION_ID" >> $GITHUB_OUTPUT
          
          # Esperar a que complete (opcional, toma 2-3 minutos)
          echo "â³ Waiting for invalidation to complete..."
          aws cloudfront wait invalidation-completed \
            --distribution-id ${{ steps.infra.outputs.cloudfront_id }} \
            --id $INVALIDATION_ID
          
          echo "âœ… Cache invalidated successfully"

      # ==========================================
      # 8. RESUMEN
      # ==========================================
      - name: Deployment Summary
        if: success()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… FRONTEND DEPLOYED SUCCESSFULLY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“¦ S3 Bucket: ${{ steps.infra.outputs.s3_bucket }}"
          echo "â˜ï¸  CloudFront Distribution: ${{ steps.infra.outputs.cloudfront_id }}"
          echo "ğŸŒ Live URL: ${{ steps.infra.outputs.cloudfront_url }}"
          echo ""
          echo "ğŸ”— Open in browser: ${{ steps.infra.outputs.cloudfront_url }}"
          echo ""
          echo "ğŸ“ Git Info:"
          echo "   Commit: ${{ github.sha }}"
          echo "   Author: ${{ github.actor }}"
          echo "   Message: ${{ github.event.head_commit.message }}"
          echo ""
          echo "â° Note: Changes may take 2-3 minutes to propagate"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Deployment Failed
        if: failure()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ DEPLOYMENT FAILED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Please check the logs above for details"
          echo "Common issues:"
          echo "  - Missing frontend/public/index.html"
          echo "  - AWS credentials not configured"
          echo "  - Terraform state not accessible"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"